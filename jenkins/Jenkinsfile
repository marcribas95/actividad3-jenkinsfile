pipeline {
    agent any
    
    environment {
        // Variables de entorno del proyecto
        GIT_REPO = 'https://github.com/marcribas95/actividad3-jenkinsfile.git'
        GIT_BRANCH = 'main'
        PROJECT_DIR = "${WORKSPACE}"
        REPORTS_DIR = "${WORKSPACE}/tests-reports"
    }
    
    options {
        // Mantener los รบltimos 10 builds
        buildDiscarder(logRotator(numToKeepStr: '10'))
        // Timeout general del pipeline
        timeout(time: 30, unit: 'MINUTES')
        // Timestamps en el log
        timestamps()
        // No permitir builds concurrentes
        disableConcurrentBuilds()
    }
    
    stages {
        stage('๐ Checkout') {
            steps {
                script {
                    echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
                    echo 'โ  DESCARGANDO CรDIGO DEL REPOSITORIO'
                    echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
                }
                
                // Descargar cรณdigo del repositorio Git
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${GIT_BRANCH}"]],
                    userRemoteConfigs: [[url: "${GIT_REPO}"]]
                ])
                
                script {
                    echo 'โ Cรณdigo descargado exitosamente'
                    echo "โ Branch: ${GIT_BRANCH}"
                    echo "โ Workspace: ${WORKSPACE}"
                }
            }
        }
        
        stage('๐ง Setup') {
            steps {
                script {
                    echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
                    echo 'โ  CONFIGURANDO ENTORNO'
                    echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
                }
                
                // Configurar entorno virtual e instalar dependencias
                sh '''
                    make setup
                '''
                
                script {
                    echo 'โ Entorno configurado correctamente'
                }
            }
        }
        
        stage('๐งช Test Unitarios') {
            steps {
                script {
                    echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
                    echo 'โ  EJECUTANDO PRUEBAS UNITARIAS'
                    echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
                }
                
                // Ejecutar pruebas unitarias
                sh '''
                    make test-unit
                '''
                
                script {
                    echo 'โ Pruebas unitarias completadas'
                }
            }
        }
        
        stage('๐ Test API') {
            steps {
                script {
                    echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
                    echo 'โ  EJECUTANDO PRUEBAS DE API'
                    echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
                }
                
                // Ejecutar pruebas de API
                sh '''
                    make test-api
                '''
                
                script {
                    echo 'โ Pruebas de API completadas'
                }
            }
        }
        
        stage('๐ Test E2E') {
            steps {
                script {
                    echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
                    echo 'โ  EJECUTANDO PRUEBAS END-TO-END'
                    echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
                }
                
                // Ejecutar pruebas e2e con Docker
                sh '''
                    make test-e2e
                '''
                
                script {
                    echo 'โ Pruebas E2E completadas'
                }
            }
        }
        
        stage('๐ Anรกlisis de Resultados') {
            steps {
                script {
                    echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
                    echo 'โ  ANALIZANDO RESULTADOS DE PRUEBAS'
                    echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
                }
                
                // Publicar reportes de pruebas JUnit
                junit(
                    testResults: 'tests-reports/test-results-*.xml',
                    allowEmptyResults: false,
                    skipPublishingChecks: false,
                    keepLongStdio: true
                )
                
                script {
                    echo 'โ Reportes de pruebas publicados'
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
                echo 'โ  LIMPIEZA Y FINALIZACIรN'
                echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
            }
            
            // Detener servicios Docker si estรกn corriendo
            sh '''
                make docker-down || true
            '''
            
            // Archivar logs y reportes
            archiveArtifacts(
                artifacts: 'tests-reports/*.xml, tests-reports/*.log',
                allowEmptyArchive: true,
                fingerprint: true
            )
            
            script {
                echo 'โ Artefactos archivados'
            }
        }
        
        success {
            script {
                echo ''
                echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
                echo 'โ  โ BUILD EXITOSO - TODAS LAS PRUEBAS PASARON              โ'
                echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
                echo ''
            }
        }
        
        failure {
            script {
                echo ''
                echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
                echo 'โ  โ BUILD FALLIDO - ALGUNAS PRUEBAS FALLARON               โ'
                echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
                echo ''
            }
        }
        
        unstable {
            script {
                echo ''
                echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
                echo 'โ  โ BUILD INESTABLE - REVISAR RESULTADOS                   โ'
                echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
                echo ''
            }
        }
    }
}
